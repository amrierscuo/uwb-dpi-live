<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>UWB Live Map - Live Mode</title>
  <style>
    body{margin:0;background:#0f172a;color:#e5e7eb;font-family:sans-serif}
    #controls{padding:10px;background:#111827;text-align:center}
    #urlInput{width:60%;padding:5px;border-radius:4px;border:1px solid #374151;background:#1f2937;color:#e5e7eb}
    #connectBtn{padding:5px 10px;margin-left:8px;border:none;border-radius:4px;background:#2563eb;color:#fff;cursor:pointer}
    #status{padding:8px;background:#111827;text-align:center}
    canvas{display:block;margin:20px auto;border:2px solid #1f2937;border-radius:8px}
  </style>
</head>
<body>
  <div id="controls">
    <input id="urlInput" type="text" placeholder="wss://..." />
    <button id="connectBtn">Connetti</button>
  </div>
  <div id="status">Connessione non avviata</div>
  <canvas id="map" width="800" height="800"></canvas>

  <script>
  // --- Configurazione mappa ---
  const WORLD={w:100,h:100,
    zones:[{x:15,y:15,w:30,h:22,level:"crit"},
           {x:60,y:50,w:20,h:25,level:"warn"}]};
  const COLORS={ok:"#22c55e",warn:"#f59e0b",crit:"#ef4444"};
  const canvas=document.getElementById("map"),ctx=canvas.getContext("2d");
  const scale=canvas.width/WORLD.w;
  const statusEl=document.getElementById("status");

  let agents=new Map();
  let ws;
  let reconnectDelay=2000;
  let wsUrl="";

  // --- Disegno ---
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // zone
    for(const z of WORLD.zones){
      ctx.fillStyle=z.level==="crit"?"rgba(239,68,68,.2)":"rgba(245,158,11,.2)";
      ctx.fillRect(z.x*scale,z.y*scale,z.w*scale,z.h*scale);
    }
    // agenti
    for(const a of agents.values()){
      ctx.fillStyle=COLORS[a.status||"ok"];
      ctx.beginPath();ctx.arc(a.x*scale,a.y*scale,6,0,Math.PI*2);ctx.fill();
      ctx.fillText(a.id,a.x*scale+10,a.y*scale);
    }
  }
  function loop(){ draw(); requestAnimationFrame(loop); }
  loop();

  // --- Gestione WS ---
  function connectWS(){
    if(!wsUrl){statusEl.textContent="Inserisci un URL WebSocket valido";return;}
    ws = new WebSocket(wsUrl);

    ws.onopen=()=>{
      statusEl.textContent="Connesso a "+wsUrl;
      statusEl.style.background="#064e3b";
    };
    ws.onclose=()=>{
      statusEl.textContent="Disconnesso, riconnessione...";
      statusEl.style.background="#7f1d1d";
      setTimeout(connectWS,reconnectDelay);
    };
    ws.onerror=()=>{
      statusEl.textContent="Errore connessione";
      statusEl.style.background="#7f1d1d";
      ws.close();
    };
    ws.onmessage=(ev)=>{
      try{
        const msg=JSON.parse(ev.data);
        if(msg.tags){
          for(const t of msg.tags){
            agents.set(t.id,t);
          }
        }
      }catch(e){console.error(e);}
    };
  }

  // --- UI: textbox + bottone ---
  document.getElementById("connectBtn").onclick=()=>{
    wsUrl=document.getElementById("urlInput").value.trim();
    if(ws){ try{ws.close();}catch(e){} }
    agents.clear();
    connectWS();
  };
  </script>
</body>
</html>
